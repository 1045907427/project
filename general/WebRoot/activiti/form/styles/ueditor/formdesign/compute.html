<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>运算控件</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" >
    <meta name="generator" content="www.leipi.org" />
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <!--[if lte IE 6]>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-ie6.css">
    <![endif]-->
    <!--[if lte IE 7]>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/ie.css">
    <![endif]-->
    <link rel="stylesheet" href="agent.style.css">
    <script type="text/javascript" src="../dialogs/internal.js"></script>
    <script type="text/ecmascript" src="../../../../js/sha1.js"></script>
    <script type="text/ecmascript" src="../../../../js/jquery.js"></script>
    <script type="text/javascript">
        /* Thank you by
         http://www.alt-tag.com/blog/2006/02/ie-dom-bugs/ */
        function createElement(type, name)
        {
            var element = null;
            try {
                element = document.createElement('<'+type+' name="'+name+'">');
            } catch (e) {}
            if(element==null) {
                element = document.createElement(type);
                element.name = name;
            }
            return element;
        }
    </script>
    <style type="text/css">
        [ctype] {
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="content">
    <table class="table table-bordered table-striped table-hover">
        <tr>
            <th><span>控件名称</span><span class="label label-important">*</span></th>
            <th><span>长&nbsp;&nbsp;X&nbsp;&nbsp;宽&nbsp;&nbsp;&&nbsp;&nbsp;字体大小</span> </th>
        </tr>
        <tr>
            <td><input type="text" id="orgname" placeholder="必填项"></td>
            <td>
                <input id="orgwidth" type="text" value="150" class="input-small span1" placeholder="auto"/>
                X
                <input id="orgheight" type="text" value="" class="input-small span1" placeholder="auto"/>
                &
                <input id="orgfontsize" type="text"  value="" class="input-small span1" placeholder="auto"/> px
            </td>
        </tr>
        <tr>
            <th><span>保留小数位</span></th>
            <th></th>
        </tr>
        <tr>
            <td><input id="orgfix" type="text" class="" placeholder="默认保留2位，不能超过6位小数。"/></td>
            <td></td>
        </tr>
        <tr>
            <th colspan="2"><span>表达式</span><span class=""></span></th>
        </tr>
        <tr>
            <td colspan="2">
                <span id="numbers"style="border-right: solid 0px #aaa; padding: 5px 15px 5px 5px;">数字：　
                    <input type="button" value="1" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="1">
                    <input type="button" value="2" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="2">
                    <input type="button" value="3" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="3">
                    <input type="button" value="4" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="4">
                    <input type="button" value="5" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="5">
                    <input type="button" value="6" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="6">
                    <input type="button" value="7" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="7">
                    <input type="button" value="8" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="8">
                    <input type="button" value="9" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="9">
                    <input type="button" value="0" class="btn btn-small" style="width: 30px;" onclick="addNumeric(this.value)" title="0">
                    <input type="button" value="．" class="btn btn-small" style="width: 30px;" onclick="addNumeric('.')" title="小数点">
                </span>
                <div style="height: 5px; border-bottom: dashed 1px #ddd;"></div>
                <div style="height: 5px;"></div>
                <span id="operators" style="border-right: solid 1px #aaa; padding: 5px 15px 5px 5px;">操作符：
                    <input type="button" value="+" class="btn btn-small" style="width: 30px;" onclick="addOperator(this.value)" title="+">
                    <input type="button" value="-" class="btn btn-small" style="width: 30px;" onclick="addOperator(this.value)" title="-">
                    <input type="button" value="*" class="btn btn-small" style="width: 30px;" onclick="addOperator(this.value)" title="*">
                    <input type="button" value="/" class="btn btn-small" style="width: 30px;" onclick="addOperator(this.value)" title="/">
                    <input type="button" value="(" class="btn btn-small" style="width: 30px;" onclick="addBracket(this.value)" title="(">
                    <input type="button" value=")" class="btn btn-small" style="width: 30px;" onclick="addBracket(this.value)" title=")">
                </span>
                <span id="operators2" style="border-right: solid 0px #aaa; padding: 5px 15px 5px 20px;">
                    <input type="button" value="←" class="btn btn-small" style="width: 30px;" onclick="popOperator()" title="BackSpace">
                    <input type="button" value="C" class="btn btn-small" style="width: 30px;" onclick="clrOperator()" title="清空">
                </span>
                <div style="height: 5px; border-bottom: dashed 1px #ddd;"></div>
                <div style="height: 5px;"></div>
                <span id="items" style="border-right: solid 0px #aaa; padding: 5px 15px 5px 5px;">项目：　
                    <select style="margin-bottom: 5px;" id="item">
                    </select>
                    <input type="button" value="添加" class="btn" style="margin-bottom: 5px;" onclick="addItem()">
                </span>
                <div style="width: 100%; border-bottom: solid 1px #aaa; margin: 5px 0px 5px 0px;"></div>
                <div id="buffer" style="width: 550px; height: 80px; border: solid 1px #ddd; font-size: 18px;" class="img-rounded"></div>
            </td>
        </tr>
    </table>
</div>
<script type="text/javascript">

    var fix = 2;
    var max = 6;

    var oNode = null,thePlugins = 'compute';
    var expression1 = new Array();
    //var expression2 = new Array();
    var relate = new Array();
    window.onload = function() {
        if( UE.plugins[thePlugins].editdom ){
            oNode = UE.plugins[thePlugins].editdom;
            //var gValue = '';
            //if(oNode.getAttribute('value'))
            //    gValue = oNode.getAttribute('value').replace(/&quot;/g,"\"");
            var gTitle=oNode.getAttribute('title').replace(/&quot;/g,"\""),gHidden=oNode.getAttribute('orghide'),gFontSize=oNode.getAttribute('orgfontsize'),gAlign=oNode.getAttribute('orgalign'),gWidth=oNode.getAttribute('orgwidth'),gHeight=oNode.getAttribute('orgheight'),gType=oNode.getAttribute('orgtype');
            var gExpressionText = oNode.getAttribute('expressiontext');
            var gExpression = oNode.getAttribute('expression');
            var gExpressionRelate = oNode.getAttribute('expressionrelate');
            var gFix = oNode.getAttribute('orgfix');
            //gValue = gValue==null ? '' : gValue;
            gTitle = gTitle==null ? '' : gTitle;
            //$G('orgvalue').value = gValue;
            $G('orgname').value = gTitle;
            //if (gHidden == '1')
            //{
            //    $G('orghide').checked = true;
            //}
            $G('orgfontsize').value = gFontSize;
            $G('orgwidth').value = gWidth;
            $G('orgheight').value = gHeight;
            $G('orgfix').value = gFix;
            $('#buffer').append(gExpressionText);
            expression1 = gExpression.split(',');
            relate = gExpressionRelate.split(',');

            //$G('orgalign').value = gAlign;
            //$G('orgtype').value = gType;
        }

        $('#orgfix').change(function() {

            var v = $(this).val();
            var v = v.replace(/[\u0000-\u002f]/gi, '').replace(/[\u003a-\u00ff]/gi, '');

            if(v == '') {
                v = fix;
            }
            //
            v = v > max ? max : v;

            $(this).val(v);
        });

        // 去除控件名称中的半角字符
        // 验证名称是否重复
        $('#orgname').change(function() {

            // 去除控件名称中的半角字符
            var orgname = $('#orgname').val();
            orgname = orgname.replace(/[\u0000-\u002F]/gi, '').replace(/[\u003a-\u0040]/gi, '').replace(/[\u005b-\u0060]/gi, '').replace(/[\u007b-\u00ff]/gi, '');
            $('#orgname').val(orgname);

            // 验证名称是否重复
            if (orgname != '') {

                for (var i = 0; i < UE.controls.length; i++) {
                    var name = UE.controls[i];
                    if(name == orgname) {
                        alert('控件名称重复，请重新输入！');
                        $(this).val('');
                        return false;
                    }
                }
            }
        });

        if(null != null) {
            var orgname = oNode.getAttribute('title').replace(/&quot;/g, "\"");
            for (var i = 0; i < UE.controls.length; i++) {

                var name = UE.controls[i];
                if (name == orgname) {
                    UE.controls.splice(i, 1, '');
                    break;
                }
            }
        }

        // 初始化项目select
        $.each(UE.computes, function(index, value) {

            if(value == gTitle) {
            } else {
                $('#item').append('<option value="' + value + '">' + value + '</option>');
                //$('#item').removeAttr('disabled');
            }
        });

    }
    dialog.oncancel = function () {
        if( UE.plugins[thePlugins].editdom ) {
            delete UE.plugins[thePlugins].editdom;
        }
    };
    dialog.onok = function (){
        if($G('orgname').value==''){
            alert('请输入控件名称');
            return false;
        }

        var expressionFlg = true;
        try {

            if(expression1.length > 0) {

                var exp = $('#buffer').text();
                exp = exp.replace(/\{(\w|[\u4e00-\u9fa5])+\}/g, function(){

                    return Math.random() + 1;
                });
                eval(exp);
            }

        }catch (e) {
            expressionFlg = false;
        }

        if(!expressionFlg) {
            alert('似乎表达式不正确！请检查表达式的语法是否正确。');
            return expressionFlg;
        }

        var gTitle=$G('orgname').value.replace(/\"/g,"&quot;"),gFontSize=$G('orgfontsize').value,gWidth=$G('orgwidth').value,gHeight=$G('orgheight').value;
        var gFix=$G('orgfix').value;

        if( !oNode ) {
            try {
                oNode = createElement('input','NEWFIELD');
                oNode.setAttribute('type','text');
                oNode.setAttribute('title',gTitle);
                oNode.setAttribute('agentitemid',hex_sha1(gTitle));
                oNode.setAttribute('name','NEWFIELD');
                oNode.setAttribute('plugins',thePlugins);
                oNode.setAttribute('orgfix',gFix);
                if( gFontSize != '' ) {
                    oNode.style.fontSize = gFontSize + 'px';
                    //style += 'font-size:' + gFontSize + 'px;';
                    oNode.setAttribute('orgfontsize',gFontSize );
                }
                if( gWidth != '' ) {
                    oNode.style.width = gWidth+ 'px';
                    //style += 'width:' + gWidth + 'px;';
                    oNode.setAttribute('orgwidth',gWidth );
                }
                if( gHeight != '' ) {
                    oNode.style.height = gHeight+ 'px';
                    //style += 'height:' + gHeight + 'px;';
                    oNode.setAttribute('orgheight',gHeight );
                }

                //oNode.setAttribute('style',style );
                //oNode.style.cssText=style;//ie7

                // 表达式
                oNode.setAttribute('expression', expression1.join(','));
                oNode.setAttribute('expressiontext', $('#buffer')[0].innerHTML);
                oNode.setAttribute('expressionrelate', relate.join(','));

                editor.execCommand('insertHtml',oNode.outerHTML);
            } catch (e) {
                try {
                    editor.execCommand('error');
                } catch ( e ) {
                    alert('控件异常，如果一直出现该提示，请联系系统管理员！');
                }
                return false;
            }
        } else {

            oNode.setAttribute('type','text');
            oNode.setAttribute('title', gTitle);
            oNode.setAttribute('agentitemid',hex_sha1(gTitle));
            oNode.setAttribute('plugins',thePlugins);
            oNode.setAttribute('orgfix',gFix);
            //oNode.setAttribute('value', $G('orgvalue').value);
            if( gFontSize != '' ) {
                oNode.style.fontSize = gFontSize+ 'px';
                oNode.setAttribute('orgfontsize',gFontSize );
            }else{
                oNode.style.fontSize = '';
                oNode.setAttribute('orgfontsize', '');
            }
            if( gWidth != '' ) {
                oNode.style.width = gWidth+ 'px';
                oNode.setAttribute('orgwidth',gWidth );
            }else{
                oNode.style.width = '';
                oNode.setAttribute('orgwidth', '');
            }
            if( gHeight != '' ) {
                oNode.style.height = gHeight+ 'px';
                oNode.setAttribute('orgheight',gHeight );
            }else{
                oNode.style.height = '';
                oNode.setAttribute('orgheight', '');
            }

            // 表达式
            oNode.setAttribute('expression', expression1.join(','));
            oNode.setAttribute('expressiontext', $('#buffer')[0].innerHTML);
            oNode.setAttribute('expressionrelate', relate.join(','));

            delete UE.plugins[thePlugins].editdom;
        }
    };

    function addNumeric(d) {

        var last = $('#buffer').children().last().text();
        var regex = new RegExp('^[0-9]+(.[0-9]*)?$')
        if(regex.test(last) && (regex.test(d) || d == '.')) {

            if(d == '.') {
                if(last.indexOf('.') >= 0) {
                    return true;
                }
            }

            $('#buffer').children().last().append(d);

            var str = expression1.pop();
            str = str + d;
            expression1.push(str);

            return true;
        }

        var html = new Array();
        html.push('<div style="padding: 3px; float: left;" ctype="numeric">' + d + '</div>');
        $('#buffer').append(html.join(''));
        expression1.push(d);

        relate.push('');
    }

    function addOperator(d) {

        var html = new Array();
        html.push('<div style="padding: 3px; float: left;" ctype="numeric">' + d + '</div>');
        $('#buffer').append(html.join(''));
        expression1.push(d);

        relate.push('');
    }

    function popOperator() {
        $('#buffer').children().last().remove();
        expression1.pop();

        relate.pop();
    }

    function clrOperator() {
        $('#buffer').empty();
        expression1 = new Array();

        relate = new Array();
    }

    function addItem() {

        var item = $('#item').val();
        if(item == undefined || item == '' || item == null) {
            return true;
        }
        var html = new Array();
        html.push('<div style="padding: 3px; float: left;" ctype="item">{' + item + '}</div>');
        $('#buffer').append(html.join(''));
        expression1.push('toNumeric($(\'input[title="' + item + '"]\').val())');

        relate.push(item);
    }

    function addBracket(d) {

        var html = new Array();
        html.push('<div style="padding: 3px; float: left;" ctype="bracket">' + d + '</div>');
        $('#buffer').append(html.join(''));
        expression1.push(d);

        relate.push('');
    }

</script>
</body>
</html>